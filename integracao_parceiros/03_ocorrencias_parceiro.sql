/*
	SELECT codigo_integracao, id_nota_fiscal_imp, id_nota_fiscal_parceiro, data_ocorrencia, id_ocorrencia
	FROM scr_notas_fiscais_imp
	WHERE codigo_integracao IN (400, 401)
	ORDER BY data_registro DESC
SELECT * FROM scr_notas_fiscais_imp_ocorrencias WHERE id_nota_fiscal_imp = 677042
	INSERT INTO msg_fila_edi (id_notificacao, id_chave_notificacao, id_banco_dados)
	VALUES (20,749137::text,31);

	SELECT numero_romaneio, id_romaneio, data_saida FROM scr_romaneios WHERE id_transportador_redespacho = 98

	UPDATE scr_romaneios SET emitido = 0 WHERE id_transportador_redespacho = 98;
	UPDATE scr_romaneios SET emitido = 1 WHERE id_transportador_redespacho = 98;

	BEGIN;
	DELETE FROM scr_notas_fiscais_imp_ocorrencias WHERE data_registro >= '2020-09-08 13:50:26.479699' AND id_nota_fiscal_imp IN (11602,11705,11730,11843,15357,15425,15402,15509,15498,15498,15509,15755,15742,15751,16020,16022,16005,16023,16033,16048,16000,16002,16018,16282,16324,16213,16202,16334,16381,16424,16433,16438,16566,16582,16558,16545,16584,16765,16738,16734,16771,16725,16840,16880,16959,16966,16932,16954,17222,17188,17334,17163,17325,17175,17287,17351,17352,17353,17354,17350,17473,17475,17476,17491,17402,17403,17404,17405,17406,17407,17409,17410,17412,17414,17415,17416,17422,17423,17426,17427,17428,17429,17434,17435,17437,17438,17439,17440,17441,17442,17444,17445,17446,17447,17450,17451,17452,17453,17454,17456,17457,17458,17459,17462,17463,17464,17466,17468,17469,17470,17472,17478,17479,17480,17485,17487,17488,17613,17589,17591,17541,17548,17577,17633,17602,17587,17582,17596,17605,17631,17542,17598,17624,17581,17600,17565,17586,17573,17619,17580,17558,17606,17628,17561,17590,17525,17593,17540,17571,17482,17530,17630,17627,17574,17551,17539,17576,17601,17570,17640,17543,17592,17634,17562,17618,17544,17575,17622,17533,17536,17585,17556,17381,17546,17567,17599,17607,17610,17644,17646,17537,17568,17595,17637,17638,17527,17569,17588,17621,17635,17629,17614,17534,17529,17594,17617,17572,17641,17625,17636,17552,17554,17611,17647,17553,17620,17604,17623,17564,17639,17615,17616,17538,17549,17645,17532,17526,17869,17870,17871,17873,17874,17875,17886,17891,17897,17903,17907,17911,17912,17918,17919,17920,17926,17930,17941,17946,17947,17950,17951,17578,17608,17626,17866,17872,17884,17887,17889,17895,17896,17905,18095,18096,17921,17923,17925,18097,17927,17928,18098,17933,17935,18099,17945,18100,18102,18103,18104,18105,18106,18107,18108,18109,18110,18111,18112,18113,18114,18115,18116,18117,18118,18119,18120,18121,18122,18123,18124,18125,18126,18150,17876,17879,17880,17882,17892,17898,17900,17901,17904,17906,17909,17910,17913,17914,17916,17924,17929,17936,17937,17940,17943,17944,17948,17949,17955,17956,17957,17959,17960,17965,17966,17967,17968,17970,17971,17972,17973,17980,17981,17983,17988,17991,17992,17994,17998,18149,18127,18129,18130,18132,18134,18135,18136,18137,18138,18140,18141,18143,18144,18145,18146,18148,18151,18152,18154,18155,18156,18158,18159,18160,18000,17954,17964,17969,17974,17976,17978,17979,17984,17985,17986,17996,17997,18258,18260,18261,18263,18264,18265,18266,18267,18281,18296,18304,18308,18313,18326,18331,18332,18381,18259,18271,18274,18280,18284,18291,18292,18293,18300,18303,18305,18306,18307,18311,18312,18315,18316,18317,18318,18319,18321,18322,18323,18327,18329,18334,18335,18337,18339,18341,18343,18344,18345,18348,18349,18350,18351,18354,18355,18356,18359,18362,18363,18365,18367,18368,18369,18370,18372,18375,18376,18378,18379,18248,18072,18236,18243,18198,17511,18439,18288,18517,18371,18459,18262,18512,18501,18502,18269,18275,18286,18287,18289,18297,18299,18302,18314,18325,18340,18353,18382,18479,18513,18276,18338,18467,18471,18451,18454,18455,18466,18483,18484,18487,18495,18400,18638,18585,18587,18604,18607,18617,18620,18621,18622,18626,18629,18285,18324,18453,18456,18457,18458,18460,18468,18469,18470,18476,18477,18478,18480,18485,18493,18496,18497,18500,18504,18505,18506,18509,18515,18516,18464,18465,18473,18474,18475,18481,18489,18491,18492,18503,18510,18514,18498,18573,18554,18566,18540,18584,18576,18637,18636,18641,18768,18885,18893,18894,18904,18911,18925,18879,18759,18770,18762,18891,18875,18900,18910,18743,18895,18783,18767,18868,18898,18757,18905,18598,18741,18589,18593,18596,18600,18602,18614,18625,18631,18632,18639,18748,18803,18806,18807,18811,18595,18599,18613,18623,18633,18740,18744,18750,18802,18805,18482,18586,18624,18731,18736,18754,18798,18808,18592,18601,18612,18628,18635,18729,18733,18742,18755,18761,18765,18771,18775,18793,18812,18588,18590,18591,18603,18728,18745,18747,18760,18769,18774,18781,18786,18789,18791,18795,18810,18605,18610,18634,18727,18737,18739,18746,18751,18752,18758,18763,18778,18779,18796,18563,18688,18717,18871,18872,18881,18882,18886,18890,18897,18909,19029,19031,19059,19060,19076,19084,19110,19116,19120,19121,18888,18896,18919,19004,19033,19057,19085,19089,19109,19124,18883,18884,18887,18889,18899,18901,19025,19083,19091,19100,19111,19128,19131,18870,18892,18907,18912,18921,19005,19034,19044,19056,19061,19067,19074,19093,19105,19129,18860,18861,18948,18954,18955,19139,19003,19143,18983,19147,19154,18994,18990,18913,19026,19055,19080,19424,19434,19453,19479,19486,19489,19495,19389,19431,19436,19449,19472,19477,19481,19482,19483,19485,19503,19014,19393,19399,19404,19410,19415,19419,19426,19433,19442,19446,19458,19071,19417,19441,19476,19500,19391,19395,19408,19414,19420,19422,19439,19451,19459,19460,19469,19484,19492,19496,19506,19054,19400,19405,19409,19425,19429,19432,19438,19440,19443,19444,19448,19457,19462,19475,19480,19490,19498,19402,19416,19427,19435,19456,19473,19474,19487,18917,18920,19027,19122,19126,19566,19603,19604,19632,19633,18908,18914,19013,19018,19396,19411,19591,19593,18915,19010,19024,19397,19748,19750,18918,19011,19558,19567,19585,19590,19602,19630,19645,19747,19751,19358,19375,19381,19605,19624,19658,19672,19702,19705,19733,19740,19660,19679,19718,19730,19974,19976,19574,19582,19595,19598,19607,19635,19794,19798,19106,19562,19563,19568,19594,19606,19609,19611,19614,19622,19646,19649,19808,19570,19636,19647,19653,19724,19728,19734,19745,19081,19703,19725,19731,18606,19744,19681,19732,19036,19721,19571,19634,19670,19737,19719,19671,19597,19701,19665,19608,19708,19790,19666,19575,18787,19683,19577,19009,19573,19580,19596,19620,19623,19639,19652,19654,19682,19738,19743,19584,19612,19692,19727,19752,19801,19804,19805,19561,19565,19572,19581,19613,19621,19638,19648,19803,19643,19655,19667,19720,19723,19726,19736,19741,19789,19546,19548,19556,19557,20257,20243,20115,20067,20065,20268,20266,20265,20264,20255,20247,20112,20111,20110,20103,20026,20023,19893,19870,19859,19710,19699,19618,19119,20267,20262,20261,20260,20259,20258,20251,20249,20245,20235,20232,20101,20097,19913,19837,19559,19115,19923,19890,19862,20016,19925,19922,19878,19937,19892,19946,19884,19876,19867,20004,19998,19993,19904,19885,19868,19845,19586,19933,19869,19858,19839,19626,19959,19928,19840,19711,19588,19911,19863,19941,19895,19871,19926,20022,20009,19912,19052,19938,19631,20033,20018,19932,19958,19907,19656,19939,19909,19881,19931,19935,19936,19625,20008,20000,19627,19619,19872,19851,20006,19090,19896,19087,19877,19704,19640,19856,19934,20010,20011,20002,19997,19995,19978,19916,19914,19902,19715,19601,19600,19583,19578,19008,20032,20029,19972,19971,19857,19835,19687,19675,19659,19629,19471,19467,19092,19082,19070,19048,19040,19019,19016,19007,19948,19918,19846,19739,19642,19628,19564,19095,20001,19977,19973,19970,19927,19836,19800,19685,19677,19616,19132,19125,19094,19072,19042,19039,19021,19017,19012,20031,19968,19898,19791,19746,19714,19709,19615,19579,19502,19466,19047,19030,19673,19729,19688,19043,19102,19678,19068,19069,19690,19676,19834,19696,19641,19589,19075,19695,19717,19113,19108,19994,19103,19960,19686,19114,19592,20003,19940,19900,19981,19879,20005,19915,19992,20020,20019,20027,19930,19844,19465,19952,19860,19079,19847,19975,19112,19684,19950,19883,19735,19722,19716,19707,19706,19697,19644,19637,19587,19078,18780) AND id_ocorrencia = 303;
	
	SELECT string_agg(id_romaneio::text,',') FROM scr_romaneios WHERE id_transportador_redespacho = 98;
COMMIT;

	SELECT string_agg(id_nota_fiscal_imp::text,',') FROM scr_romaneio_nf WHERE id_romaneio IN (405,419,318,106,238,252,272,344,250,251,288,301,363,369,374,385,398,410,415,444,337,333,326,434,439,428,424,443)

	select * FROM scr_notas_fiscais_imp_ocorrencias WHERE id_nota_fiscal_imp in (11602,11705,11730,11843,15357,15425,15402,15509,15498,15498,15509,15755,15742,15751,16020,16022,16005,16023,16033,16048,16000,16002,16018,16282,16324,16213,16202,16334,16381,16424,16433,16438,16566,16582,16558,16545,16584,16765,16738,16734,16771,16725,16840,16880,16959,16966,16932,16954,17222,17188,17334,17163,17325,17175,17287,17351,17352,17353,17354,17350,17473,17475,17476,17491,17402,17403,17404,17405,17406,17407,17409,17410,17412,17414,17415,17416,17422,17423,17426,17427,17428,17429,17434,17435,17437,17438,17439,17440,17441,17442,17444,17445,17446,17447,17450,17451,17452,17453,17454,17456,17457,17458,17459,17462,17463,17464,17466,17468,17469,17470,17472,17478,17479,17480,17485,17487,17488,17613,17589,17591,17541,17548,17577,17633,17602,17587,17582,17596,17605,17631,17542,17598,17624,17581,17600,17565,17586,17573,17619,17580,17558,17606,17628,17561,17590,17525,17593,17540,17571,17482,17530,17630,17627,17574,17551,17539,17576,17601,17570,17640,17543,17592,17634,17562,17618,17544,17575,17622,17533,17536,17585,17556,17381,17546,17567,17599,17607,17610,17644,17646,17537,17568,17595,17637,17638,17527,17569,17588,17621,17635,17629,17614,17534,17529,17594,17617,17572,17641,17625,17636,17552,17554,17611,17647,17553,17620,17604,17623,17564,17639,17615,17616,17538,17549,17645,17532,17526,17869,17870,17871,17873,17874,17875,17886,17891,17897,17903,17907,17911,17912,17918,17919,17920,17926,17930,17941,17946,17947,17950,17951,17578,17608,17626,17866,17872,17884,17887,17889,17895,17896,17905,18095,18096,17921,17923,17925,18097,17927,17928,18098,17933,17935,18099,17945,18100,18102,18103,18104,18105,18106,18107,18108,18109,18110,18111,18112,18113,18114,18115,18116,18117,18118,18119,18120,18121,18122,18123,18124,18125,18126,18150,17876,17879,17880,17882,17892,17898,17900,17901,17904,17906,17909,17910,17913,17914,17916,17924,17929,17936,17937,17940,17943,17944,17948,17949,17955,17956,17957,17959,17960,17965,17966,17967,17968,17970,17971,17972,17973,17980,17981,17983,17988,17991,17992,17994,17998,18149,18127,18129,18130,18132,18134,18135,18136,18137,18138,18140,18141,18143,18144,18145,18146,18148,18151,18152,18154,18155,18156,18158,18159,18160,18000,17954,17964,17969,17974,17976,17978,17979,17984,17985,17986,17996,17997,18258,18260,18261,18263,18264,18265,18266,18267,18281,18296,18304,18308,18313,18326,18331,18332,18381,18259,18271,18274,18280,18284,18291,18292,18293,18300,18303,18305,18306,18307,18311,18312,18315,18316,18317,18318,18319,18321,18322,18323,18327,18329,18334,18335,18337,18339,18341,18343,18344,18345,18348,18349,18350,18351,18354,18355,18356,18359,18362,18363,18365,18367,18368,18369,18370,18372,18375,18376,18378,18379,18248,18072,18236,18243,18198,17511,18439,18288,18517,18371,18459,18262,18512,18501,18502,18269,18275,18286,18287,18289,18297,18299,18302,18314,18325,18340,18353,18382,18479,18513,18276,18338,18467,18471,18451,18454,18455,18466,18483,18484,18487,18495,18400,18638,18585,18587,18604,18607,18617,18620,18621,18622,18626,18629,18285,18324,18453,18456,18457,18458,18460,18468,18469,18470,18476,18477,18478,18480,18485,18493,18496,18497,18500,18504,18505,18506,18509,18515,18516,18464,18465,18473,18474,18475,18481,18489,18491,18492,18503,18510,18514,18498,18573,18554,18566,18540,18584,18576,18637,18636,18641,18768,18885,18893,18894,18904,18911,18925,18879,18759,18770,18762,18891,18875,18900,18910,18743,18895,18783,18767,18868,18898,18757,18905,18598,18741,18589,18593,18596,18600,18602,18614,18625,18631,18632,18639,18748,18803,18806,18807,18811,18595,18599,18613,18623,18633,18740,18744,18750,18802,18805,18482,18586,18624,18731,18736,18754,18798,18808,18592,18601,18612,18628,18635,18729,18733,18742,18755,18761,18765,18771,18775,18793,18812,18588,18590,18591,18603,18728,18745,18747,18760,18769,18774,18781,18786,18789,18791,18795,18810,18605,18610,18634,18727,18737,18739,18746,18751,18752,18758,18763,18778,18779,18796,18563,18688,18717,18871,18872,18881,18882,18886,18890,18897,18909,19029,19031,19059,19060,19076,19084,19110,19116,19120,19121,18888,18896,18919,19004,19033,19057,19085,19089,19109,19124,18883,18884,18887,18889,18899,18901,19025,19083,19091,19100,19111,19128,19131,18870,18892,18907,18912,18921,19005,19034,19044,19056,19061,19067,19074,19093,19105,19129,18860,18861,18948,18954,18955,19139,19003,19143,18983,19147,19154,18994,18990,18913,19026,19055,19080,19424,19434,19453,19479,19486,19489,19495,19389,19431,19436,19449,19472,19477,19481,19482,19483,19485,19503,19014,19393,19399,19404,19410,19415,19419,19426,19433,19442,19446,19458,19071,19417,19441,19476,19500,19391,19395,19408,19414,19420,19422,19439,19451,19459,19460,19469,19484,19492,19496,19506,19054,19400,19405,19409,19425,19429,19432,19438,19440,19443,19444,19448,19457,19462,19475,19480,19490,19498,19402,19416,19427,19435,19456,19473,19474,19487,18917,18920,19027,19122,19126,19566,19603,19604,19632,19633,18908,18914,19013,19018,19396,19411,19591,19593,18915,19010,19024,19397,19748,19750,18918,19011,19558,19567,19585,19590,19602,19630,19645,19747,19751,19358,19375,19381,19605,19624,19658,19672,19702,19705,19733,19740,19660,19679,19718,19730,19974,19976,19574,19582,19595,19598,19607,19635,19794,19798,19106,19562,19563,19568,19594,19606,19609,19611,19614,19622,19646,19649,19808,19570,19636,19647,19653,19724,19728,19734,19745,19081,19703,19725,19731,18606,19744,19681,19732,19036,19721,19571,19634,19670,19737,19719,19671,19597,19701,19665,19608,19708,19790,19666,19575,18787,19683,19577,19009,19573,19580,19596,19620,19623,19639,19652,19654,19682,19738,19743,19584,19612,19692,19727,19752,19801,19804,19805,19561,19565,19572,19581,19613,19621,19638,19648,19803,19643,19655,19667,19720,19723,19726,19736,19741,19789,19546,19548,19556,19557,20257,20243,20115,20067,20065,20268,20266,20265,20264,20255,20247,20112,20111,20110,20103,20026,20023,19893,19870,19859,19710,19699,19618,19119,20267,20262,20261,20260,20259,20258,20251,20249,20245,20235,20232,20101,20097,19913,19837,19559,19115,19923,19890,19862,20016,19925,19922,19878,19937,19892,19946,19884,19876,19867,20004,19998,19993,19904,19885,19868,19845,19586,19933,19869,19858,19839,19626,19959,19928,19840,19711,19588,19911,19863,19941,19895,19871,19926,20022,20009,19912,19052,19938,19631,20033,20018,19932,19958,19907,19656,19939,19909,19881,19931,19935,19936,19625,20008,20000,19627,19619,19872,19851,20006,19090,19896,19087,19877,19704,19640,19856,19934,20010,20011,20002,19997,19995,19978,19916,19914,19902,19715,19601,19600,19583,19578,19008,20032,20029,19972,19971,19857,19835,19687,19675,19659,19629,19471,19467,19092,19082,19070,19048,19040,19019,19016,19007,19948,19918,19846,19739,19642,19628,19564,19095,20001,19977,19973,19970,19927,19836,19800,19685,19677,19616,19132,19125,19094,19072,19042,19039,19021,19017,19012,20031,19968,19898,19791,19746,19714,19709,19615,19579,19502,19466,19047,19030,19673,19729,19688,19043,19102,19678,19068,19069,19690,19676,19834,19696,19641,19589,19075,19695,19717,19113,19108,19994,19103,19960,19686,19114,19592,20003,19940,19900,19981,19879,20005,19915,19992,20020,20019,20027,19930,19844,19465,19952,19860,19079,19847,19975,19112,19684,19950,19883,19735,19722,19716,19707,19706,19697,19644,19637,19587,19078,18780) ORDER BY data_registro


	SELECT id_fornecedor, cnpj_cpf FROM fornecedores WHERE id_fornecedor = 98

	
	
*/

CREATE OR REPLACE FUNCTION f_tgg_fila_baixa_parceiro()
  RETURNS trigger AS
$BODY$
DECLARE
	vCodigoIntegracao integer;
	v_id_db integer;
BEGIN

	
	SELECT codigo_integracao
	INTO vCodigoIntegracao
	FROM scr_notas_fiscais_imp
	WHERE id_nota_fiscal_imp = NEW.id_nota_fiscal_imp;
	
	BEGIN
		IF NEW.id_ocorrencia > 0 AND NEW.id_ocorrencia < 100 THEN
			
			SELECT id_string_conexao
			INTO v_id_db 
			FROM string_conexoes 
			WHERE banco_dados = current_database();

			
			IF TG_TABLE_NAME = 'scr_notas_fiscais_imp_ocorrencias' THEN 	
					
				--vCodigoIntegracao = fp_get_session('codigo_integracao_' || NEW.id_nota_fiscal_imp::text);
				IF vCodigoIntegracao IN (400,401) THEN 
					INSERT INTO msg_fila_edi (id_notificacao, id_chave_notificacao, id_banco_dados)
					VALUES (20,NEW.id_ocorrencia_nf::text,v_id_db);
				END IF;
			END IF;

			IF TG_TABLE_NAME = 'scr_conhecimento_ocorrencias_nf' THEN 
				vCodigoIntegracao = fp_get_session('codigo_integracao_' || NEW.id_conhecimento_ocorrencia_nf::text);
				IF vCodigoIntegracao IN (400,401) THEN 
					INSERT INTO msg_fila_edi (id_notificacao, id_chave_notificacao, id_banco_dados)
					VALUES (20,NEW.id_conhecimento_ocorrencia_nf::text,v_id_db);
				END IF;
			END IF;

			
		END IF;
	EXCEPTION WHEN OTHERS  THEN	

	END;
         
	RETURN NEW;
END;
$BODY$
  LANGUAGE plpgsql VOLATILE;


CREATE TRIGGER tgg_zz0_fila_baixa_parceiro
AFTER INSERT OR UPDATE 
ON scr_notas_fiscais_imp_ocorrencias
FOR EACH ROW
EXECUTE PROCEDURE f_tgg_fila_baixa_parceiro();

CREATE TRIGGER tgg_zz1_fila_baixa_parceiro
AFTER INSERT OR UPDATE 
ON scr_conhecimento_ocorrencias_nf
FOR EACH ROW
EXECUTE PROCEDURE f_tgg_fila_baixa_parceiro();


